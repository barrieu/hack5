<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="https://unpkg.com/jspsych@7.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.0"></script>
    <link href="https://unpkg.com/jspsych@7.1.2/css/jspsych.css" rel="stylesheet" type="text/css" />

    <audio id="audio" src="oodlesOfSounds.ogg" preload="auto"></audio>

  </head>

  <body>
    <div id="jspsych_target"></div>
    <button onclick="dummyPress()">Press to Activate Audio</button>
    <button onclick="playTheTones()">sound the tone</button>
  </body>

  <script>
  console.log("setting up audiocontext at ver 16 ");
  const audioContext = new AudioContext();
  const element = document.querySelector("audio");
  const source = audioContext.createMediaElementSource(element);
  const gainNode = audioContext.createGain();

  gainNode.gain.setValueAtTime(0, audioContext.currentTime);
  source.connect(gainNode);
  gainNode.connect(audioContext.destination);

  function dummyPress(){
    audioContext.resume();
    playTheTones();
  };


  function playTheTones(){
       element.currentTime = 2;
       //gainNode.gain.exponentialRampToValueAtTime(1.0, 2);
       gainNode.gain.setTargetAtTime(1.0, audioContext.currentTime, 0.1);
       //gainNode.gain.setTargetAtTime(0.0001, audioContext.currentTime + 0.8, 1.0);

       var g = setTimeout(function(){
         //gainNode.gain.exponentialRampToValueAtTime(0.001, 1.4);
         gainNode.gain.setTargetAtTime(0.0001, audioContext.currentTime, 0.199);
         console.log("start Down @   " + element.currentTime);
         //clearTimeout(g);
       },800);

       element.play();
       console.log("PLAYING 2 now @   " + element.currentTime);
       var k = setTimeout(function(){
         element.pause();
         console.log("STOPPED @   " + element.currentTime);
       },2000);

       setTimeout(function(){
         element.currentTime = 230;
         gainNode.gain.setTargetAtTime(1.0, audioContext.currentTime, 0.1);

         gainNode.gain.setTargetAtTime(0.0001, audioContext.currentTime + 0.8, 1.0);
         var h = setTimeout(function(){
           //gainNode.gain.exponentialRampToValueAtTime(0.001, 1.4);
           gainNode.gain.setTargetAtTime(0.0001, audioContext.currentTime, 0.199);
           console.log("start Down @   " + element.currentTime);
           //clearTimeout(g);
         },800);

         element.play();
         console.log("PLAYING 250 now @   " + element.currentTime);
         var j = setTimeout(function(){
           element.pause();
           //clearInterval(k);
           console.log("STOPPED @   " + element.currentTime);
         },2000);
       },3000);

      };


  </script>
</html>
